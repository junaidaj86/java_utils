# Logger

This project is a common logging library for Quarkus based applications.
It produces logs aligned with a specific log format.  

Application logs and audit logs can be generated using the methods declared
in NdmLogger and NdmAuditor. Also logs generated by Quarkus libraries and other
third party libraries are automatically converted to the required logging
format. These logs include only mandatory fields required.

## Usage

Applications can use the NdmLogger and NdmAuditor class methods (info, warn,
error, debug) according to their needs. These methods take "LogRecord" object
as parameter. The LogRecord objects are expected to be built by the code
invoking the NdmLogger and NdmAuditor methods.

Please be careful to specify category and tags as specified in privacy
design rules for logs.

Privacy data can be wrapped by pre-defined tags of NdmPrivacyType in extra data:

```shell
NdmLogger.debug(LogRecord.builder()
        .message("log message")
        .extraData(Map.of(USERNAME, NdmPrivacyType.USERNAME.wrap(user.getUsername())))
        .build());
```

Or the Tags can be added to class fields by annotation and then mapped to extra data:

```java
public class User {
    @NdmPrivacyTag(NdmPrivacyType.USERNAME)
    private final String username;
}
```

```shell
NdmLogger.debug(LogRecord.builder()
       .message("log message")
       .extraData(PrivacyTagHelper.toExtraData(user))
       .build());
```

## X-Flow-ID logging

X-Flow-ID is an important field in the library. It is used to include a
correlation ID in the logs. This correlation ID is shared between the micro-
services involved in a request flow and it can thus be used to track the
lifecycle of a request.

For the external requests, coming from outside of the cluster, Kong (API Gw) is
responsible for generating a unique flow ID and include it in the X-Flow-ID
extension header to be used in logs produced by microservices downstream.

Request flows started by timers and other internal triggers should generate
a flow ID on their own. The flow ID is a UUID4 and thus globally unique, also
when generated by different parties.

## Maven dependency

```xml
<dependency>
    <groupId>com.postnord.ndm.base</groupId>
    <artifactId>logger</artifactId>
    <version>add version</version>
</dependency>
```

The staging build generates the version.

## Application.yaml

In application.yaml file below lines need to be added.

```yaml
quarkus:
  log:
    console:
      json:
        fields:
          level:
            enabled: false
          stack-trace:
            enabled: false
          logger-class-name:
            enabled: false
          logger-name:
            enabled: false
          sequence:
            enabled: false
          thread-name:
            enabled: false
          thread-id:
            enabled: false
          hostname:
            enabled: false
          process-name:
            enabled: false
          process-id:
            enabled: false
          timestamp:
            date-format: yyyy-MM-dd'T'HH:mm:ss.SSS'Z'
            zone-id: UTC
            enabled: true
        additional-field:
          service_id:
            value: test_service_id
          version:
            value: 1.1.0
    level: INFO
    category:
      "com.postnord":
        level: DEBUG
  index-dependency:
    logger:
      group-id: com.postnord.ndm.base
      artifact-id: logger
```

The DEBUG log level for category "com.postnord" above is useful for development
but too verbose for production. It must be changed to INFO before the
application is deployed to production. This can be done by Helm to avoid having
to switch the value back and fourth in the application configuration file.
