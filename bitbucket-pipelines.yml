image: public.ecr.aws/a1t5b6y5/ndm/java17-maven-base:latest

pipelines:
  custom:
    deploy-to-artifactory-dev:
      - step:
          name: Build and Test
          caches:
            - maven
          script:
            - mvn -s settings.xml clean install deploy
    build-credit-micro-service-container:
      - step:
          name: Build and deploy
          caches:
            - maven
          services:
            - docker
          script:
            - cd credit-micro-service
            - mvn -s ../settings.xml clean install -Dpmd.skip=true -Dmaven.test.skip=true
            - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            - unzip awscliv2.zip
            - sudo ./aws/install
            - IMAGE="ndm/credit-micro-service"
            - TAG=${BITBUCKET_BUILD_NUMBER}.${BITBUCKET_COMMIT}
            - aws configure set aws_access_key_id "${AWS_KEY}"
            - aws configure set aws_secret_access_key "${AWS_SECRET}"
            - eval $(aws ecr get-login --no-include-email --region eu-west-1 | sed 's;https://;;g')
            - docker build -f src/main/docker/Dockerfile.jvm -t ${IMAGE}:${TAG} .
            - docker push ${IMAGE}:${TAG}
